<!DOCTYPE html>
<html lang="{{ locale }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('Budget Management') }}</title>
    <link rel="stylesheet" href="/static/styles/style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header/Navigation -->
        <div class="header">
            <div class="nav-bar">
                <p class="welcome-text">{{ _('Welcome,') }} {{ username }}!</p>
                <div class="balance-display">
                    <span class="balance-label">{{ _('Current Balance:') }}</span>
                    <span class="balance-amount {% if current_balance >= 0 %}amount-positive{% else %}amount-negative{% endif %}">
                        ${{ "%.2f"|format(current_balance) }}
                    </span>
                </div>
            </div>
            <nav class="nav-links">
                <a href="{{ url_for('home') }}">{{ _('Dashboard') }}</a>
                <a href="{{ url_for('manage_tags') }}">{{ _('Manage Tags') }}</a>
                <a href="{{ url_for('manage_budgets') }}" style="background: rgba(33, 150, 243, 0.1);">{{ _('Manage Budgets') }}</a>
                <a href="{{ url_for('manage_friends') }}">{{ _('Friends') }}</a>
                <a href="{{ url_for('logout') }}" style="color: #f44336;">{{ _('Logout') }}</a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Budgets Overview Section -->
            <div class="expense-section">
                <div class="section-header">
                    <h2 class="section-title">{{ _('Budget Management') }}</h2>
                    <button type="button" class="btn-primary" onclick="openAddBudgetModal()">{{ _('Add New Budget') }}</button>
                </div>
                
                <div class="budgets-grid">
                    {% if budgets %}
                        {% for budget in budgets %}
                        <div class="budget-card">
                            <div class="budget-header">
                                <h3 class="budget-category">{{ budget[1] }}</h3>
                                <div class="budget-actions">
                                    <button type="button" class="btn-edit" onclick="openEditBudgetModal('{{ budget[0] }}', '{{ budget[1] }}', '{{ budget[2] }}', '{{ budget[3] }}', '{{ budget[4] }}')">{{ _('Edit') }}</button>
                                    <button type="button" class="btn-delete" onclick="deleteBudget('{{ budget[0] }}')">{{ _('Delete') }}</button>
                                </div>
                            </div>
                            <div class="budget-stats">
                                <div class="stat-item">
                                    <span class="stat-label">{{ _('Budget Amount:') }}</span>
                                    <span class="stat-value">${{ "%.2f"|format(budget[2]) }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">{{ _('Spent:') }}</span>
                                    <span class="stat-value amount-negative">${{ "%.2f"|format(budget[6]) }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">{{ _('Remaining:') }}</span>
                                    <span class="stat-value {% if budget[7] >= 0 %}amount-positive{% else %}amount-negative{% endif %}">
                                        ${{ "%.2f"|format(budget[7]) }}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">{{ _('Progress:') }}</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ budget[8] }}%; background-color: {% if budget[8] > 100 %}#f44336{% elif budget[8] > 80 %}#ff9800{% else %}#4caf50{% endif %};"></div>
                                    </div>
                                    <span class="progress-text">{{ "%.1f"|format(budget[8]) }}%</span>
                                </div>
                            </div>
                            <div class="budget-period">
                                <span class="period-label">{{ _('Period:') }}</span>
                                <span class="period-value">{{ budget[3] }} - {{ budget[4] }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-budgets">
                            <p>{{ _('No budgets found. Create your first budget!') }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="card-title">{{ _('Quick Actions') }}</h3>
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="openAddBudgetModal()">{{ _('Add New Budget') }}</button>
                        <a href="{{ url_for('home') }}" class="btn-secondary">{{ _('Back to Dashboard') }}</a>
                    </div>
                </div>

                <!-- Budget Summary -->
                <div class="summary-card">
                    <h3 class="card-title">{{ _('Budget Summary') }}</h3>
                    <div class="summary-item">
                        <span class="summary-label">{{ _('Total Budgets') }}</span>
                        <span class="summary-value">{{ budget_count }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">{{ _('Total Budget Amount') }}</span>
                        <span class="summary-value">${{ "%.2f"|format(total_budget_amount) }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">{{ _('Total Spent') }}</span>
                        <span class="summary-value amount-negative">${{ "%.2f"|format(total_spent) }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">{{ _('Overall Progress') }}</span>
                        <span class="summary-value">{{ "%.1f"|format(overall_progress) }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="addBudgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ _('Add New Budget') }}</h2>
                <span class="close" onclick="closeAddBudgetModal()">&times;</span>
            </div>
            <form action="{{ url_for('add_budget') }}" method="post">
                <div class="msg">{{ msg }}</div>
                
                <label for="budget_name">{{ _('Budget Name:') }}</label>
                <input type="text" name="budget_name" id="budget_name" placeholder="{{ _('Enter budget name') }}" required>
                
                <label for="category_id">{{ _('Category:') }}</label>
                <select name="category_id" id="category_id" required>
                    {% for category in categories %}
                        <option value="{{ category[0] }}">{{ category[1] }}</option>
                    {% endfor %}
                </select>
                
                <label for="amount">{{ _('Budget Amount:') }}</label>
                <input type="number" name="amount" id="amount" step="0.01" min="0.01" placeholder="{{ _('Enter budget amount') }}" required oninvalid="showAmountError(this)" oninput="clearAmountError(this)">
                <div id="amount-error" class="error-message" style="display: none;"></div>
                
                <label for="start_date">{{ _('Start Date:') }}</label>
                <input type="date" name="start_date" id="start_date" required>
                
                <label for="end_date">{{ _('End Date:') }}</label>
                <input type="date" name="end_date" id="end_date" required>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary">{{ _('Add Budget') }}</button>
                    <button type="button" class="btn-secondary" onclick="closeAddBudgetModal()">{{ _('Cancel') }}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Budget Modal -->
    <div id="editBudgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ _('Edit Budget') }}</h2>
                <span class="close" onclick="closeEditBudgetModal()">&times;</span>
            </div>
            <form action="{{ url_for('edit_budget') }}" method="post">
                <div class="msg">{{ msg }}</div>
                
                <input type="hidden" name="budget_id" id="edit_budget_id">
                
                <label for="edit_budget_name">{{ _('Budget Name:') }}</label>
                <input type="text" name="budget_name" id="edit_budget_name" placeholder="{{ _('Enter budget name') }}" required>
                
                <label for="edit_category_id">{{ _('Category:') }}</label>
                <select name="category_id" id="edit_category_id" required>
                    {% for category in categories %}
                        <option value="{{ category[0] }}">{{ category[1] }}</option>
                    {% endfor %}
                </select>
                
                <label for="edit_amount">{{ _('Budget Amount:') }}</label>
                <input type="number" name="amount" id="edit_amount" step="0.01" min="0.01" placeholder="{{ _('Enter budget amount') }}" required oninvalid="showAmountError(this)" oninput="clearAmountError(this)">
                <div id="edit-amount-error" class="error-message" style="display: none;"></div>
                
                <label for="edit_start_date">{{ _('Start Date:') }}</label>
                <input type="date" name="start_date" id="edit_start_date" required>
                
                <label for="edit_end_date">{{ _('End Date:') }}</label>
                <input type="date" name="end_date" id="edit_end_date" required>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary">{{ _('Update Budget') }}</button>
                    <button type="button" class="btn-secondary" onclick="closeEditBudgetModal()">{{ _('Cancel') }}</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Modal functionality
        function openAddBudgetModal() {
            document.getElementById('addBudgetModal').style.display = 'block';
        }

        function closeAddBudgetModal() {
            document.getElementById('addBudgetModal').style.display = 'none';
        }

        function openEditBudgetModal(budgetId, budgetName, amount, startDate, endDate) {
            document.getElementById('edit_budget_id').value = budgetId;
            document.getElementById('edit_budget_name').value = budgetName;
            document.getElementById('edit_amount').value = amount;
            document.getElementById('edit_start_date').value = startDate;
            document.getElementById('edit_end_date').value = endDate;
            document.getElementById('editBudgetModal').style.display = 'block';
        }

        function closeEditBudgetModal() {
            document.getElementById('editBudgetModal').style.display = 'none';
        }

        function deleteBudget(budgetId) {
            if (confirm("{{ _('Are you sure you want to delete this budget?') }}")) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('delete_budget') }}";
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'budget_id';
                input.value = budgetId;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Custom validation functions
        function showAmountError(input) {
            const errorDiv = input.id === 'amount' ? document.getElementById('amount-error') : document.getElementById('edit-amount-error');
            const currentLocale = '{{ locale }}';
            
            if (currentLocale === 'zh') {
                errorDiv.textContent = '金额必须大于或等于0.01';
            } else {
                errorDiv.textContent = 'Value must be greater than or equal to 0.01';
            }
            errorDiv.style.display = 'block';
        }

        function clearAmountError(input) {
            const errorDiv = input.id === 'amount' ? document.getElementById('amount-error') : document.getElementById('edit-amount-error');
            errorDiv.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            var addModal = document.getElementById('addBudgetModal');
            var editModal = document.getElementById('editBudgetModal');
            
            if (event.target == addModal) {
                addModal.style.display = 'none';
            }
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
        }
    </script>
</body>
</html> 